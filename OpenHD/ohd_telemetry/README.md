# Developer information

## Summary:
This module deals with all (mavlink) telemetry, including the mavlink extended parameters protocol
for changing settings.

### Endpoints
An endpoint (under src/endpoints) receives and/ or transmits a continuous mavlink data stream. We have:
1) serial - the uart connection FC<->[AIR UNIT] and [GND UNIT] -> Tracker
2) wifibroadcast - for transmission of telemetry data via the wifibroadcast link (provided by ohd_interface)
3) udp - the connection openhd <-> qopenhd on the ground unit, preferred
4) tcp - for creating a mavlink server on the ground / air, can also be used by GCS, not preferred but
   usefully in some networking situations.

## OHDMainComponent (Component)
Used by both the air and ground unit implementation, generates fire-and-forget mavlink statistics

## XMavlinkParamProvider (Component)
A bit dirty, uses mavlink extended parameters protocol to expose the settings for a specific openhd
component (Air unit, ground unit, Camera1, Camera2)

## AirTelemetry/GroundTelemetry
Passes around all the mavlink messages via callbacks, exposes functionality for other modules to register
mavlink extended parameters settings (e.g. camera1 gives all its settings to AirTelemetry and then is notified
on changes via cb)

## OHDTelemetry
Wraps either an AirTelemetry / GroundTelemetry instance.

# NOTE
The code in here is much more complicated than one might hope, since the routing for example is quite
difficult. However, you should be able to easily follow a stream of data by going through the callbacks
in an IDE.

## Preconditions

Transmission / receiving of telemetry data from the air/ground unit is separated from this module.
We just forward / get the telemetry data from the telemetry data handle provided by ohd_interface (in the end, the data is sent/received
via wifibroadcast). Note that this connection is lossy - we use the features provided by mavlink to ensure re-transmissions if needed.

## Routing

Routing: I recommend reading this first: https://github.com/mavlink-router/mavlink-router
Special OpenHD approaches (in general, they help us save bandwidth by not forwarding messages to systems that do not need them)
1) Fire and forget: Wherever possible, we use fire and forget message(s). Any OpenHD statistics / telemetry generated by the air unit
   are forwarded to the ground unit, which then forwards them to any connected Ground Station
   Any OpenHD statistics / telemetry generated by the ground unit is not forwarded to the air unit (to save bandwidth) but only to
   all the connected ground stations.
2) FC: OpenHD provides direct access to the FC, but itself does not modify / use data from the FC in any way. Messages created by the FC
   (which is connected to the air unit) are forwarded to the ground unit and then forwarded to the ground station(s). Any message created by
    the ground station(s) is forwarded to the air unit, and then to the FC
3) Settings: OpenHD settings can be modified via the mavlink extended parameters protocol. They are local to the air or grund unit, depending on
   where they are needed. 

## System / Comp ID's

This module declares two mavlink sys IDs - one for the Air unit and one for the Ground unit. Camera(s) have their own component id, the rest uses
the same comp id.

## Handling commands

Commands can be sent to either the air or grund unit (target comp / sys id). Example:
https://github.com/OpenHD/OpenHD/blob/2.2.4-evo/OpenHD/ohd_telemetry/src/internal/OHDMainComponent.cpp#L66

## External (HW) systems

Air unit sends/receives data from the FC if enabled, Ground unit receives data from a joystick (if enabled, RC).

## Connecting the  Ground station application to this module running on the Ground Pi (QOpenHD or QGroundControl)

Rn, there is only one way to connect either QOpenHD or QGroundControl to this module running on the ground pi - a
bidirectional connection made up of 2 UDP ports. TODO: When QOpenHD / QGroundControl is not running on the ground
station itself, but rather on another device (for example a smartphone connected to the ground pi), another difficulty
arises from the necessity to route the messages over another network. For this, we probably should go with TCP, but the
TCPEndpoint still needs some work. The corresponding endpoint in QOpenHD can be found
here: https://github.com/OpenHD/QOpenHD/blob/consti-test/app/telemetry/OHDConnection.h

